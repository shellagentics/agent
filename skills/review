#!/usr/bin/env bash
#
# review - Code review skill
#
# Reviews staged changes or a specific file.
#
# Usage:
#   ./skills/review              # review staged changes
#   ./skills/review file.py      # review specific file
#   git diff HEAD~3 | ./skills/review   # review piped diff
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AGEN="${SCRIPT_DIR}/../agen"

SYSTEM_PROMPT='You are a code reviewer. Be concise and actionable.
Focus on:
- Bugs and logic errors
- Security issues
- Performance problems
Skip style nitpicks unless they affect readability significantly.
Format: bullet points, most important first.'

# Check for piped input
if [[ ! -t 0 ]]; then
  # Stdin is piped
  exec "$AGEN" --system=/dev/stdin "Review this diff" <<< "$SYSTEM_PROMPT"
fi

# Check for file argument
if [[ $# -gt 0 ]]; then
  file="$1"
  if [[ ! -f "$file" ]]; then
    echo "review: File not found: $file" >&2
    exit 1
  fi
  cat "$file" | "$AGEN" --system=<(echo "$SYSTEM_PROMPT") "Review this code"
  exit 0
fi

# Default: review staged changes
staged=$(git diff --cached)
if [[ -z "$staged" ]]; then
  staged=$(git diff)
fi

if [[ -z "$staged" ]]; then
  echo "review: No changes to review"
  exit 0
fi

echo "$staged" | "$AGEN" --system=<(echo "$SYSTEM_PROMPT") "Review this diff"
